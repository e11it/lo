
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">g.e11it.ru/go/lo/builder/field.go (57.4%)</option>
				
				<option value="file1">g.e11it.ru/go/lo/builder/main.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" >package builder

import (
        "fmt"
        "reflect"
        "strconv"
        "strings"
        "time"
)

type formField struct {
        Required bool
        Field    string
        Default  bool
        Name     string
        Type     string
        TFunc    TypeFunc
        Ext      string
        Val      interface{}
}

type TypeFunc func() string

func GetField(field reflect.StructField, val interface{}) *formField <span class="cov0" title="0">{
        // Field with default values
        rField := &amp;formField{
                Required: false,
                Default:  false,
                Type:     "text",
                Val:      val,
        }

        if field.Tag.Get("required") == "true" </span><span class="cov0" title="0">{
                rField.Required = true
        }</span>

        <span class="cov0" title="0">if field.Tag.Get("default") == "true" </span><span class="cov0" title="0">{
                rField.Default = true
        }</span>

        //
        <span class="cov0" title="0">rField.Type, rField.TFunc = rField.ValidateTypeSetCustoms(field.Tag.Get("type"))
        // For select and radio get tag with type name
        if ok := rField.HasExt(); ok </span><span class="cov0" title="0">{
                rField.Ext = field.Tag.Get(rField.Type)
        }</span>

        <span class="cov0" title="0">return rField</span>
}

func (self *formField) HasExt() bool <span class="cov0" title="0">{
        if self.Type == "radio" || self.Type == "select" </span><span class="cov0" title="0">{
                return true
        }</span>
        <span class="cov0" title="0">return false</span>
}

/*
 * Проверяет type. Определяет дополнительные обработчики
 */
func (self *formField) ValidateTypeSetCustoms(val string) (string, TypeFunc) <span class="cov0" title="0">{
        switch val </span>{
        <span class="cov0" title="0">case "text", "password", "hidden", "button":
                return val, nil</span>
        <span class="cov0" title="0">case "textarea":
                return "", nil</span>
        <span class="cov0" title="0">case "radio":
                return "", nil</span>
        <span class="cov0" title="0">case "checkbox":
                return "", nil</span>
        <span class="cov0" title="0">default:
                return "text", nil</span>
        }
}

func (self *formField) getHtmlLabel() string <span class="cov8" title="1">{
        if len(self.Name) &gt; 0 </span><span class="cov8" title="1">{
                return fmt.Sprintf("&lt;label for=\"%s\"&gt;%s&lt;/label&gt;", self.Field, self.Name)
        }</span>
        <span class="cov8" title="1">return ""</span>
}

func (self *formField) getOpenCloseElement() (string, string) <span class="cov8" title="1">{
        switch self.Type </span>{
        <span class="cov8" title="1">case "text", "password", "hidden", "button", "checkbox", "radio":
                return fmt.Sprintf("input type=\"%s\"", self.Type), ""</span>
        <span class="cov0" title="0">case "select", "textarea":
                return self.Type, fmt.Sprintf("&lt;/%s&gt;", self.Type)</span>
        }
        <span class="cov0" title="0">return "", ""</span>
}

/*
 * Если нет  customBuilder - то value берется либо из стркутуры, либо default
 * Если есть customBuilder - то value обрабоатывает сам builder
 */
func (self *formField) getHTML() string <span class="cov8" title="1">{
        var (
                html    string
                options []string
        )
        label := self.getHtmlLabel()
        //
        openEl, closeEl := self.getOpenCloseElement()
        //
        if value, isset := self.valueIsDefined(); isset </span><span class="cov8" title="1">{
                options = append(options, fmt.Sprintf("value=\"%s\"", value))
        }</span><span class="cov8" title="1"> else if self.Default &amp;&amp; reflect.ValueOf(self.Val).IsValid() </span><span class="cov0" title="0">{
                options = append(options, fmt.Sprintf("value=\"%s\"", self.Val))
        }</span>
        <span class="cov8" title="1">options = append(options, fmt.Sprintf("name=\"%s\"", self.Field))

        //
        strOptions := strings.Join(options, " ")
        //

        html = fmt.Sprintf("%s&lt;%s %s&gt;%s&lt;br&gt;", label, openEl, strOptions, closeEl)
        return html</span>
}

//
func (self *formField) valueIsDefined() (string, bool) <span class="cov8" title="1">{
        var value string
        rval := reflect.ValueOf(self.Val)
        switch rval.Kind() </span>{
        <span class="cov8" title="1">case reflect.String:
                value = rval.String()
                break</span>
        <span class="cov8" title="1">case reflect.Bool:
                value = strconv.FormatBool(rval.Bool())
                break</span>
        <span class="cov8" title="1">case reflect.Int, reflect.Int64:
                if rval.Type() == reflect.ValueOf((time.Duration)(0)).Type() </span><span class="cov8" title="1">{
                        value = rval.Interface().(time.Duration).String()
                }</span><span class="cov8" title="1"> else {
                        value = strconv.FormatInt(rval.Int(), 10)
                }</span>
                <span class="cov8" title="1">break</span>
        <span class="cov8" title="1">case reflect.Uint, reflect.Uint64:
                value = strconv.FormatUint(rval.Uint(), 10)
                break</span>
        <span class="cov0" title="0">case reflect.Float64:
                value = strconv.FormatFloat(rval.Float(), 'f', 2, 64)
                break</span>
        }

        <span class="cov8" title="1">if len(value) &gt; 0 </span><span class="cov8" title="1">{
                return value, true
        }</span>
        <span class="cov8" title="1">return "", false</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package builder

import (
        "reflect"
)

func FormCreate(formStruct interface{}) (string, error) <span class="cov0" title="0">{
        var (
                html string
                err  error
        )
        typ := reflect.TypeOf(formStruct)
        val := reflect.ValueOf(formStruct)

        if typ.Kind() == reflect.Ptr </span><span class="cov0" title="0">{
                typ = typ.Elem()
                val = val.Elem()
        }</span>

        <span class="cov0" title="0">for i := 0; i &lt; typ.NumField(); i++ </span><span class="cov0" title="0">{
                rawField := typ.Field(i)

                // Skip ignored("-"" or empty) and unexported field in the struct
                if rawField.Tag.Get("field") == "-" || rawField.Tag.Get("field") == "" || !val.Field(i).CanInterface() </span><span class="cov0" title="0">{
                        continue</span>
                }

                //field := GetField(rawField, val.Field(i).Interface())

        }

        <span class="cov0" title="0">return html, err</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible = document.getElementById('file0');
		files.addEventListener('change', onChange, false);
		function onChange() {
			visible.style.display = 'none';
			visible = document.getElementById(files.value);
			visible.style.display = 'block';
			window.scrollTo(0, 0);
		}
	})();
	</script>
</html>
